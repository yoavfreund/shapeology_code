# Local Cell Extractor
This documentation describes how to finish the cell extraction step on your computer locally.
## Structure
The structure is as follows:
* **scripts/extractPatches.py**: Extracts all cells from a given file. Get file path and yaml file path as input and generate a directory based on filename.
    ```bash
    python $SHAPEOLOGY_DIR/scripts/extractPatches.py <filename>.tif yaml_path
    ```
    ```
    optional arguments:
      <filename>.tif    Path to the image file to process
      yaml_path         Path to Yaml file with parameters = $SHAPEOLOGY_DIR/scripts/shape_params.yaml
    
    generate:
      one directory called <filename>_cells located in $ROOT_DIR/cells/. The directory contains one pickle file per padding size. The patches in each file are randomly permuted.
    ```
* **scripts/Cells_extractor.py**: Extracts all cells from all images of a given directory. See details in `Usage`.
* **scripts/SortFile_v2.py**: Permute cell files in a random order. See details in `Usage`.

## Usage
#### Step 1. Extracting cells from your images
This step is to extract all cells from your brain section images. The generated files are located in `$ROOT_DIR/cells/`.
```bash
python $SHAPEOLOGY_DIR/scripts/Cells_extractor.py image_dir 
```
```
optional arguments:
  --yaml          Path to Yaml file with parameters, default=$SHAPEOLOGY_DIR/scripts/shape_params.yaml
  image_dir       Path to the directory saving brain images, e.g. "$ROOT_DIR/data_processed/DK39/"

generate:
  directories generated by extractPatches.py
```
#### Step 2. Permute cell files in a random order
This step is to process the cell files generated by `Cells_extractor.py`
and prepare them for the diffusion map step. The generated files are located in `$ROOT_DIR/permute/`.
```bash
python $SHAPEOLOGY_DIR/scripts/SortFile_v2.py 
```
``` 
optional arguments:
    --file_num   Number of permuted files to generate, K, defult=20
    --cell_num   Number of cells in one permuted file, M, defult=100000
    --src_root   The directory containing cell files, default='$ROOT_DIR/cells/'
    --stem       stem of filename of permuted files, default='permute/permuted'
```
Note:
* In `extractPatches.py`, cells are stored in files per padding sizes and permuted randomly already for each section.
* We create K files for each padding size with M cells in each file. 
* In one file, collect cells from each brain section based on the proportion
 of the number of cells in each section to the total. Then permute these 
 cells in a random order.