## Guidlines for Cell Shape Analysis

### Configuration Files
* **..\environ.sh**: Exports the environment variables used for this project. These variables point to the directories of this deployment.
Details:
```bash
export SHAPOLOGY_DIR=~/Github/shapeology_code  # Directory where you git clone this project
export ROOT_DIR=~/BstemAtlasDataBackup/ucsd_brain/  # Directory for storing downloaded files and project results
export VAULT=~/Github/VaultBrain/             # Directory for credential files
export venv_dir=~/Github/venv/shapeology_venv  # Directory for virtual environment
```
* **Vault**: Contains all the credential/deployment specific files. Must be out of the project directory.
    * **dj_local_conf.json**: Specifies the credentials and the schema that is to be used for Datajoint connection. Format:
    ```json
    {"database.host": your_host_address,
    "database.password": your_datajoint_password,
    "database.user": your_user_name,
    "database.port": your_port,
    "schema": your_schema_name
    }
    ```
    * **s3-creds.json**: Specifies the credentials for AWS connection. Format:
    ```json
    {"access_key": your_aws_access_key, 
    "secret_key": your_aws_secret_access_key}
    ```
    * **credFiles.yaml**: points to the above two json files. Format:
    ```yaml
    aws_fp: s3-creds.json
    dj_fp: dj_local_conf.json
    ```
* When configuration files are set, run the following commands to activate the environment variables and the virtual environment.
```bash
source $SHAPOLOGY_DIR/environ.sh
source $SHAPOLOGY_DIR/virtual_env.sh
```

## Cell Shape Analysis Pipeline
## First step: Generating cell patches
This step is to extract cells from each brain section's image.
### How to run
#### 1. Extracting cells from single section
This script extracts all of cells from a given file. Get filename and yaml path as input and generate directory based on filename.
```
python extractPatches.py <filename>.tif yaml
```
```
optional arguments:
  <filename>.tif    The image file to process
  yaml              Path to Yaml file with parameters

generate:
  directory called <filename>_cells. Directory contains one file per padding size. The patches in each file are randomly permuted.
```
#### 2. Running extractPatches.py on all sections of one brain
This script uses datajoint.populate and Cells_extractor.py to excute extractPatches.py on all sections of a given brain.
```
python Cell_datajoint/Cells_extract_datajoint.py yaml stack
```
```
optional arguments:
  yaml        Path to Yaml file with parameters
  stack       The name of the brain, type=str, default='MD594'
```
To speed up the process, this script can be run on multiple AWS instances 
([More information](Aws-jupyter.md)).

## Second step: Training for diffusion map
### Process
#### 1. Permute cells in a random order
```bash
python SortFile_v2.py file_num  cell_num  src_root  stem
```
``` 
optional arguments:
    file_num   Number of permuted files to generate, defult=K
    cell_num   Number of cells in one permuted file, defult=M
    src_root   The directory containing cell files
    stem       stem of filename of permuted files, default='permute/permuted'
```
This script is to process the cell files generated by `Cells_extract_datajoint.py`
and prepare them for analysis by K-means. 
* In `extractPatches.py`, cells are stored in files per padding sizes and permuted randomly already for each section.
* We create K files for each padding size with M cells in every
file. 
* In one file, collect cells from each section based on the proportion
 of the number of cells in each section to the total. Then permute these 
 cells in a random order.

#### 2. Find representative samples via K-means
```
python CreateVQs_v2.py padded_size  samples_size  vq_dir
```
```
positional arguments:
  padded_size    One of the three padded size, 15, 51 or 201
  samples_size   Number of samples taken for K-means
  vq_dir         directory for storing VQs
```
This script is to conclude cells into representative samples with 
a limited number.
* Find representative cells of a specific number first.
* Divide cells into clusters based on representative cells and take the 
the mean of each cluster as representative samples.




